---
title: 加密文件格式
sidebar_position: 0
---

import Ruby from '@site/src/components/Ruby';

酷狗的 `KGM` 与 `VPR` 加密文件使用相同的加密方案。

:::caution 新旧解密算法不同

此前对该文件格式经过粗略的实验提取通用的<Ruby caption="xor pad">密码表</Ruby><!--
-->来进行解密，但是对内存要求较高。此后也试验过对该密码表进行分析，精简为使用三个 16 × 17
大小的密码表进行解码。

当前版本的 KGM 和 VPR 使用相同的解密流程。

:::

加密文件头使用<Ruby caption="Little Endian">小端序</Ruby>，最小需要 `0x3c` 个字节。

```c
struct kgm_header {
    // 偏移: 0x00
    BYTE magic[0x10]; // 固定内容

    // 偏移: 0x10
    DWORD offset_to_data; // 到加密数据处的文件偏移
    DWORD encryption_type; // 加密类型，可以是 2 / 3 / 4 这三个值之一。
    DWORD key_slot; // 密钥槽号

    // 偏移: 0x1c
    BYTE file_sig[0x10]; // 文件密钥合法性验证
    BYTE file_key[0x10]; // 文件密钥

    // 偏移: 0x3c
    BYTE unused_padding[self.offset_to_data - 0x3c]; // 填充

    // 偏移: self.offset_to_data
    // 加密后的数据在从此处开始，到文件结束为止。
}
```
